<script lang="ts">
	import { onMount, onDestroy, getContext } from 'svelte';
	import { rock_store, diamond_store, player_upgrades_store } from '../stores/resources';
	// let resources: any;

	// import resources_store from '../stores/store';

	// resources_store.subscribe((items) => {
	// 	console.log(items);
	// 	//more coming
	// });
	let rocks: number;
	let diamonds: number;
	let upgrades;

	rock_store.subscribe((val) => (rocks = val));
	diamond_store.subscribe((val) => (diamonds = val));
	player_upgrades_store.subscribe((val) => (upgrades = val));

	let isRunning = false;

	function gameLoop() {
		// Perform game logic and update game state here
		if (upgrades?.rock_miners) {
			rock_store.update((prev) => prev + 0.1 * upgrades.rock_miners);
		}

		if (isRunning) {
			requestAnimationFrame(gameLoop);
		}
	}

	onMount(() => {
		// Initialize game state, resources, and assets
		// ...
		// resources = $resources_store; // Assign the store value to the local count variable
		startGameLoop();
	});

	onDestroy(() => {
		stopGameLoop();
	});

	function startGameLoop() {
		if (!isRunning) {
			isRunning = true;
			gameLoop();
		}
	}

	function stopGameLoop() {
		isRunning = false;
	}
</script>

<main>
	<!-- Game content and rendering -->
	<h1 class="text-3xl mb-24">SPACE MINING CORP</h1>
	<content class="flex gap-4 flex-col">
		<span>Rocks: {Math.floor(rocks)} ({upgrades?.rock_miners})</span>
		<span>Diamonds: {Math.floor(diamonds)}</span>
	</content>
	<br />
	<button
		class="border border-gray-500 py-2 px-4"
		on:click={() => rock_store.update((prev) => (prev += 1))}>Mine rock</button
	>
	{#if rocks >= 10}
		<button
			class="border border-gray-500 py-2 px-4"
			on:click={() => {
				rock_store.update((prev) => prev - 10);
				diamond_store.update((prev) => (prev += 1));
			}}>trade for diamond</button
		>
	{/if}

	{#if diamonds >= 5}
		<button
			class="border border-gray-500 py-2 px-4"
			on:click={() => {
				player_upgrades_store.update((prev) => ({
					...prev,
					rock_miners: upgrades.rock_miners + 1
				}));
			}}>buy automated rock miner</button
		>
	{/if}
</main>

<style>
	main {
		max-width: 800px;
		margin: 0 auto;
		padding: 2rem;
	}
</style>
